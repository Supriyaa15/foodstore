(window.webpackJsonptheoWebApp=window.webpackJsonptheoWebApp||[]).push([[55],{"14LO":function(e,t,n){"use strict";n.r(t),n.d(t,"DCXDocumentComposite",(function(){return i}));var o=n("uTW7");function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class i{constructor(e){r(this,"dcxComposite",void 0),r(this,"current",void 0),r(this,"localStoragePath",void 0),this.dcxComposite=e.composite,this.current=new o.DCXDocumentBranch({branch:e.composite.current,componentURLfn:e.componentURLfn,overrideIDfn:e.overrideIDfn}),this.localStoragePath="local-storage://"}}},"1tmr":function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var o=n("UzQk");function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class i{constructor(e,t){r(this,"branch",void 0),r(this,"node",void 0),this.branch=e,this.node=t}reparent(e){if(e!==this.node){const t=this.node.childComponents.indexOf(this);t>=0?(e.childComponents.push(this),this.node.childComponents.splice(t,1),this.node=e,this.attachToNode()):o.LegacyCoreAssert.fail("internal error: component isn't attached to the node we think it is")}}update(e){const t=this.node.childComponents.indexOf(this);t<0?o.LegacyCoreAssert.fail("replaceWith: component isn't attached to the node we think it is"):e.node===this.node?(this.detachFromNode(),this.node.childComponents.splice(t,1,e),e.attachToNode()):o.LegacyCoreAssert.fail("replaceWith: only supports same-node replacement")}}},"2uFU":function(e,t,n){"use strict";function o(e=[],t){const n=e.filter(e=>-1===e.indexOf("_REMIX_"));return[...new Set([...n,...t.getRemixAncestorsCpMachineTags()])]}function r(e){const{width:t,height:n}=e.firstPage.pageSize;return{width:t,height:n}}n.r(t),n.d(t,"getRemixAncestorsIntoMachineTags",(function(){return o})),n.d(t,"getDocumentSize",(function(){return r}))},"6lgp":function(e,t,n){"use strict";n.r(t),n.d(t,"ActionError",(function(){return o}));class o extends Error{constructor(...e){var t,n,o;super(...e),o=!1,(n="isAllowedError")in(t=this)?Object.defineProperty(t,n,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[n]=o}}t.default=o},"7the":function(e,t,n){var o,r;o=[n("xeH2"),n("YLtl"),n("UFvF"),n("MOGj"),n("a8ov")],void 0===(r=function(e,t,n,o,r){var i=r.default,a={},s=window.location.protocol+"//"+window.location.host;return a.loadFile=function(e,t){var r=n.defer();return o.dcxService.invoke("GET",s+i.decodeUrl(e),{},null,t,(function(e,t){e?r.reject(e):r.resolve(t.response)})),r.promise},a}.apply(t,o))||(e.exports=r)},"8VGm":function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return m}));var o=n("UzQk"),r=n("UFvF"),i=n.n(r),a=n("14LO"),s=n("b3Wv"),c=n.n(s),u=n("MGCh"),h=n.n(u),d=n("a8ov");function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const p=h.a.channel("SourceCPAsset");class m{constructor(e){var t;l(this,"assetId",void 0),l(this,"cpServiceDomain",void 0),l(this,"href",void 0),l(this,"skipImageFeatures",void 0),l(this,"useCpCdn",void 0),this.assetId=e.assetId,this.cpServiceDomain=e.cpServiceDomain,this.skipImageFeatures=null!==(t=e.ignoreImageFeatures)&&void 0!==t&&t,this.useCpCdn=!!e.useCpCdn}documentId(){return this.assetId}open(){return i()(this.openAsync())}async openAsync(){const e=await c.a.loadComposite(this.assetId,this.cpServiceDomain,this.useCpCdn);e.name="";const t=new a.DCXDocumentComposite({composite:e,componentURLfn:e=>d.default.encodeCPUrl(this.assetId,e.absolutePath),overrideIDfn:e=>o.GUIDUtils.makeGUID()}),n=t.current;if(o.DocumentPersistenceFactory.usesJsonDocumentEncoding(n)){const e=o.JSONDocumentDecoder.getRequiredSynchronousComponents(n);await Promise.all(e.map(async e=>{const t=d.default.encodeCPUrl(this.assetId,e),o=await c.a.loadFile(t,{responseType:"json"});n.registerContentForComponent(e,o)}))}let r;try{r=o.TheoDocument.decodeDocument(t,e=>{throw n.releaseRegisteredContent(),new Error(e.join(";"))}),this.skipImageFeatures||o.TheoDocumentUtils.createImageFeatures(r),n.releaseRegisteredContent()}catch(e){throw p.error("decoding from CP",e),r=o.TheoDocument.createDefault(),e}return r.history.postEntry("open,src=CP,was-vers="+r.versionDecoded.rawValue),r}}},FBIc:function(e,t,n){"use strict";n.r(t);var o=n("UzQk"),r=n("YLtl"),i=n("LbXs"),a=n("tWZ4"),s=n("bBG2"),c=n("MGCh"),u=n.n(c),h=n("I/Z9"),d=n("l+ZV"),l=n("hxdN"),p=n("vWh2");function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const f={red:255,green:255,blue:255},g={red:0,green:0,blue:0},v=u.a.channel("refine-cutout");var C;async function b(e){return new Promise((t,n)=>{try{e().then(e=>{t(e)}).fail(e=>{n(e)})}catch(e){n(e)}})}!function(e){e[e.kIfNecessary=0]="kIfNecessary",e[e.kAlways=1]="kAlways",e[e.kNever=2]="kNever"}(C||(C={}));class w{constructor(e){m(this,"coreWrapper",void 0),m(this,"active",!1),m(this,"entitlementController",null),m(this,"throttledTryPremiumFeature",null),m(this,"imageForma",null),m(this,"maskForma",null),m(this,"tempMaskUrlForNewCutout",null),m(this,"width",0),m(this,"height",0),m(this,"maskCanvas",null),m(this,"maskCanvasContext",null),m(this,"paintBrush",new l.a),m(this,"brushSize",20),m(this,"effectiveBrushSize",20),m(this,"brushMode",i.RefineCutoutBrushMode.NONE),m(this,"hasPendingBrushStroke",!1),m(this,"operationQueue",new p.a),m(this,"inProgressDrawOp",null),m(this,"lastGesture",null),m(this,"acceptedGestures",0),m(this,"skippedGestures",0),m(this,"sensitivity",1),this.coreWrapper=e,this.paintBrush.init()}resetGestureState(){this.acceptedGestures=0,this.skippedGestures=0,this.hasPendingBrushStroke=!1,this.lastGesture=null}reset(){var e;this.tempMaskUrlForNewCutout&&(null===(e=o.Host.imageAnalysis)||void 0===e||e.disposeTempMaskURL(this.tempMaskUrlForNewCutout),this.tempMaskUrlForNewCutout=null);this.active=!1,this.entitlementController=null,this.throttledTryPremiumFeature=null,this.imageForma=null,this.maskForma=null,this.width=0,this.height=0,this.maskCanvas=null,this.maskCanvasContext=null,this.brushMode=i.RefineCutoutBrushMode.NONE,this.resetGestureState(),this.paintBrush.destroy(),this.paintBrush=new l.a}async enter(e,t){if(this.active)throw Error("Enter/Exit mismatch");if(this.getTempMaskUrl(e))return v.warn("Ignoring refine cutout request while final mask is pending."),Promise.resolve();let n=!1,a=0;try{this.active=!0,this.entitlementController=t,this.throttledTryPremiumFeature=Object(r.throttle)(e=>{var t;null===(t=this.entitlementController)||void 0===t||t.tryPremiumFeature(e)},1e3),this.imageForma=e,this.entitlementController.isEntitledToFeature("postCustomizeCutout")&&(this.brushMode=i.RefineCutoutBrushMode.SUBTRACTIVE),this.initializeSizes(),await this.requestSave(),this.coreWrapper.suspendSave(),n=!0,this.coreWrapper.beginBranch(),a+=1,await this.ensureCutoutAndEnterMode(e),this.maskForma=this.getMaskForma(),this.coreWrapper.beginBranch(),a+=1,this.coreWrapper.events.publish("undo-redo-state-changed",{changeType:o.UndoRedoMessage.UNDO_REDO_CHANGE})}catch(e){for(let e=0;e<a;e+=1)this.coreWrapper.endBranch(!1);if(n&&this.coreWrapper.resumeSave(),this.reset(),!e.isAllowedError)throw e}}async exit(e){return this.runWithinLoadingSkrim(async()=>{if(s.default.publish(e?"editor:image:cutoutCompleted":"editor:image:cutoutCancelled"),!this.active)throw Error("Enter/Exit mismatch");if(!this.imageForma)throw Error("Image forma not set?");if(e){const e=Date.now();if(!this.maskCanvas){const e=Date.now();await this.updateMask(!1),v.info(`Updated canvas for commit in ${Date.now()-e}ms`)}await this.updateToComponentizedMask(),v.info(`Committed in ${Date.now()-e}ms`)}this.coreWrapper.endBranch(e),await this.doAction(new o.ExitRefineCutoutModeAction(this.imageForma,e)),this.coreWrapper.endBranch(e),this.coreWrapper.resumeSave(),this.reset()})}async setBrushMode(e,t="button"){this.brushMode=e;const n=e===i.RefineCutoutBrushMode.ADDITIVE?"editor:image:cutoutRestorePressed":"editor:image:cutoutErasePressed";s.default.publish(n,{contextualData1:"method:"+t});const o=e===i.RefineCutoutBrushMode.ADDITIVE?f:g;this.paintBrush.setBrushColor(o);e===i.RefineCutoutBrushMode.ADDITIVE!==this.isOriginalPreviewVisible()&&await this.togglePreviewVisible(!1)}async toggleBrushMode(e="button"){let t;switch(this.brushMode){case i.RefineCutoutBrushMode.ADDITIVE:t=i.RefineCutoutBrushMode.SUBTRACTIVE;break;case i.RefineCutoutBrushMode.SUBTRACTIVE:t=i.RefineCutoutBrushMode.ADDITIVE;break;case i.RefineCutoutBrushMode.NONE:break;default:v.error("Unknown brush mode "+this.brushMode)}if(t)return this.setBrushMode(t,e)}getBrushMode(){return this.brushMode}togglePreviewVisible(e=!0){const t=!this.isOriginalPreviewVisible();if(e){const e=t?"enabled":"disabled";s.default.publish("editor:image:cutoutShowImageToggled",{contextualData1:"state:"+e})}return this.imageForma?this.doAction(new o.ToggleRefineCutoutFullImageAction(this.imageForma)):Promise.reject(Error("Image forma not set?"))}isOriginalPreviewVisible(){return o.ImageFacade.isRefineCutoutUnmaskedImageVisible(this.imageForma)}getBrushSize(){return this.brushSize}setBrushSize(e){return this.brushMode!==i.RefineCutoutBrushMode.NONE&&(w.brushSizeChangeLogged||(w.brushSizeChangeLogged=!0,s.default.publish("editor:image:cutoutBrushSizeAdjusted")),this.brushSize=e,this.updateEffectiveBrushSize(),!0)}getEffectiveBrushSize(){return this.effectiveBrushSize}isInvertCutoutEnabled(){return this.hasCutout()}async invertCutout(){s.default.publish("editor:image:cutoutInvertPressed"),await this.initializeMaskCanvas(C.kAlways);const e=this.maskCanvasContext,t=e.globalCompositeOperation;try{e.globalCompositeOperation="difference",e.fillStyle="#fff",e.fillRect(0,0,this.width,this.height)}finally{e.globalCompositeOperation=t}const n=Date.now(),r=this.maskCanvas.toDataURL();v.info(`Encoded to data URL in ${Date.now()-n}ms`),await this.updateMaskInModel(r,o.UpdateCutoutMaskMode.Invert)}isClearCutoutEnabled(){return this.hasCutout()}async clearCutout(){s.default.publish("editor:image:cutoutResetPressed"),await this.initializeMaskCanvas(C.kNever);const e=this.maskCanvasContext;e.fillStyle="#fff",e.fillRect(0,0,this.width,this.height);const t=this.maskCanvas.toDataURL();await this.updateMaskInModel(t,o.UpdateCutoutMaskMode.ResetToOriginal,void 0,o.CutoutMode.Off)}enableAutoCutout(){const e=this.getMaskMetadata();return(null==e?void 0:e.maskSize)!==o.CutoutMaskSize.ORIGINAL}async autoCutoutForRefineCutout(){s.default.publish("editor:image:cutoutAutoPressed"),await this.runWithinLoadingSkrim(async()=>{const[e,t]=await b(()=>this.runDeepCutDirectly());await this.initializeMaskCanvas(C.kNever);const n=this.maskCanvasContext,r=await d.default.loadImageFromBlob(e.data);n.clearRect(0,0,this.width,this.height),n.drawImage(r,0,0,this.width,this.height);const i=this.maskCanvas.toDataURL();await this.updateMaskInModel(i,o.UpdateCutoutMaskMode.AutoCutout,void 0,o.CutoutMode.BackgroundRemoval,t)})}recordGesture(e,t){const n=this.lastGesture;let o=!this.hasPendingBrushStroke||!n;if(!o&&n){const r=Math.abs(n.xRelative-e)*this.width,i=Math.abs(n.yRelative-t)*this.height;o=r>=this.sensitivity||i>=this.sensitivity}if(o){const n=!this.hasPendingBrushStroke,o=this.width*e,r=this.height*t;this.inProgressDrawOp=this.operationQueue.add(()=>n?this.paintBrush.drawAt(o,r):this.paintBrush.drawTo(o,r)),this.lastGesture={xRelative:e,yRelative:t},this.acceptedGestures+=1,this.hasPendingBrushStroke=!0}else this.skippedGestures+=1;return o}endBrushStroke(){this.hasPendingBrushStroke=!1}async updateMask(e=!0){e&&(this.brushMode!==i.RefineCutoutBrushMode.ADDITIVE||w.additiveBrushAppliedLogged?this.brushMode===i.RefineCutoutBrushMode.ADDITIVE||w.subtractiveBrushAppliedLogged||(w.subtractiveBrushAppliedLogged=!0,s.default.publish("editor:image:cutoutBrushApplied",{contextualData1:"state:erase"})):(w.additiveBrushAppliedLogged=!0,s.default.publish("editor:image:cutoutBrushApplied",{contextualData1:"state:restore"}))),await this.initializeMaskCanvas(),await this.flushGesturesAndUpdateMask()}handleUndoRedo(){this.maskCanvas=null,this.maskCanvasContext=null}showMerchPopover(e,t){let n,o;switch(t){case i.PremiumFeature.BRUSH:n="editor:image:cutoutBrushSizeAdjusted";break;case i.PremiumFeature.ERASE:n="editor:image:cutoutErasePressed",o="button";break;case i.PremiumFeature.RESTORE:n="editor:image:cutoutRestorePressed",o="button";break;case i.PremiumFeature.INVERT:n="editor:image:cutoutInvertPressed";break;default:v.warn("Unknown premium feature "+t)}if(n){const e=o?{contextualData1:"method:"+o}:void 0;s.default.publish(n,e)}this.throttledTryPremiumFeature&&this.throttledTryPremiumFeature({anchorLocation:e.getBoundingClientRect(),position:"left",touchpointName:"postCustomizeCutout"})}async ensureCutoutAndEnterMode(e){const t=new o.EnterRefineCutoutModeAction(e);this.hasCutout()?(this.logAnalyticWithImageInfo("editor:image:editCutoutPressed"),await this.doAction(t)):await this.runWithinLoadingSkrim(async()=>{this.logAnalyticWithImageInfo("editor:backgroundRemovePressed");const n=new o.SetImageCutoutAction(e,new o.CutoutStyle(o.CutoutMode.BackgroundRemoval));await this.doAction(n,!0),this.coreWrapper.events.publish("show-remove-background-toast"),this.tempMaskUrlForNewCutout=this.getTempMaskUrl(e),await this.doAction(t)},750)}async flushGesturesAndUpdateMask(){if(!this.acceptedGestures)return this.resetGestureState();if(!this.imageForma)throw Error("Image forma not set?");if(!this.maskCanvas)throw Error("Mask canvas not created?");if(this.inProgressDrawOp){const e=Date.now();await this.inProgressDrawOp,this.inProgressDrawOp=null,v.info(`Had in progress, done in ${Date.now()-e}ms`)}this.resetGestureState();const e=Date.now();await this.operationQueue.add(async()=>{await this.paintBrush.updateCanvas(this.maskCanvasContext),v.info(`Updated canvas in ${Date.now()-e}ms`),this.paintBrush.clear()});const t=Date.now(),n=this.maskCanvas.toDataURL();v.info(`Encoded to data URL in ${Date.now()-t}ms`),await this.updateMaskInModel(n,o.UpdateCutoutMaskMode.RefineCutout)}initializeSizes(){if(!this.imageForma)throw Error("Image forma not set?");const e=this.imageForma.bounds;if(!e)throw Error("No image bounds?");this.width=e.width,this.height=e.height,this.paintBrush.setSize(this.width,this.height),this.updateEffectiveBrushSize()}async initializeMaskFromModel(){var e,t,n,o;const r=null===(e=this.maskForma)||void 0===e||null===(t=e.contentNode)||void 0===t?void 0:t.image;if(!r)throw Error("Bad image");const i=null===(n=this.maskForma)||void 0===n||null===(o=n.contentNode)||void 0===o?void 0:o.url;if(0!==(null==i?void 0:i.indexOf("data:"))){await b(()=>r.whenLoaded());const e=r.getPlatformImage();if(!e)throw Error("Could not fetch image element for mask");const t=r.getWidth(),n=r.getHeight();return this.drawCurrentMaskImage(e,t,n)}const a=await d.default.load(i);this.drawCurrentMaskImage(a)}async updateToComponentizedMask(){if(!this.maskCanvas||!this.imageForma)throw Error("Image forma not set or canvas not created?");if(!this.hasCutout())return void await this.doAction(new o.ApplyRasterMaskToImageAction(this.imageForma,null,!1));const e=this.getMaskMetadata();if(e&&!this.isUsingTransientURL())return;!function(e){const t=e.getContext("2d"),n=e.width,o=e.height;if(t){const e=t.getImageData(0,0,n,o),r=e.data,i=n*o;for(let e=0,t=0;e<i;e+=1,t+=4)r[t+3]=r[t],r[t]=r[t+1]=r[t+2]=255;t.putImageData(e,0,0)}}(this.maskCanvas);const t=Date.now(),n=await Object(h.canvasToBlob)(this.maskCanvas,"image/png");v.info(`Converted mask to blob in ${Date.now()-t}ms`);const r=Date.now(),i=await this.coreWrapper.saveImageComponent(n,"image/png");v.info(`Saved image component in ${Date.now()-r}ms`);const a=Date.now(),{component:s,encodedUrl:c}=i;await this.updateMaskInModel(c,o.UpdateCutoutMaskMode.RefineCutout,s.id,o.CutoutMode.BackgroundRemoval,e),v.info(`Updated mask in ${Date.now()-a}ms`)}async initializeMaskCanvas(e=C.kIfNecessary){let t=!1;if(this.maskCanvas||(this.maskCanvas=document.createElement("canvas"),this.maskCanvas.width=this.width,this.maskCanvas.height=this.height,this.maskCanvasContext=this.maskCanvas.getContext("2d"),e!==C.kNever&&(await this.initializeMaskFromModel(),t=!0)),!this.maskCanvasContext)throw Error("Did not get canvas rendering context");e!==C.kAlways||t||await this.initializeMaskFromModel()}drawCurrentMaskImage(e,t,n){const o=this.maskCanvasContext;if(o){const r=this.width,i=this.height;o.fillStyle="#000",o.fillRect(0,0,r,i),o.drawImage(e,0,0,t||r,n||i,0,0,r,i)}}async updateMaskInModel(e,t,n,r=o.CutoutMode.BackgroundRemoval,i){await this.doAction(new o.UpdateCutoutMaskAction(this.imageForma,t,e,n,r,i))}updateEffectiveBrushSize(){const e=this.imageForma?Math.abs(this.imageForma.totalPlacement.transformValues.xscale):1,t=this.brushSize/e;this.effectiveBrushSize=this.paintBrush.setBrushSize(t)*e}async runWithinLoadingSkrim(e,t=0){try{this.coreWrapper.events.publish("show-app-loading-indicator",a.default.REFINE_CUTOUT_OP),this.coreWrapper.events.publish("ui:disableUndoButtons",{value:!0}),await e()}finally{setTimeout(()=>{this.coreWrapper.events.publish("ui:disableUndoButtons",{value:!1}),this.coreWrapper.events.publish("hide-app-loading-indicator",a.default.REFINE_CUTOUT_OP)},t)}}getMaskForma(){return o.ImageFacade.getCutoutMaskFormaForForma(this.imageForma)}getMaskMetadata(){return o.ImageFacade.getCutoutMaskMetadataForForma(this.imageForma)}hasCutout(){return o.ImageFacade.getCutoutModeForForma(this.imageForma)!==o.CutoutMode.Off}runDeepCutDirectly(){return o.ImageFacade.runDeepCutDirectly(this.imageForma)}getTempMaskUrl(e){var t;const n=o.ImageFacade.getCutoutMaskFormaForForma(e),r=null===(t=o.ImageFacade.getImageContentForForma(n))||void 0===t?void 0:t.url;return r&&o.Host.imageAnalysis.isTempMaskURL(r)?r:null}isUsingTransientURL(){var e;const t=null===(e=o.ImageFacade.getImageContentForForma(this.maskForma))||void 0===e?void 0:e.url;return!!t&&(t.indexOf("data:")>=0||t.indexOf("blob:")>=0)}doAction(e,t){return n=()=>this.coreWrapper.doAction(e,t),new Promise((e,t)=>{try{n().then(t=>{e(t)}).catch(e=>{t(e)}).done()}catch(e){t(e)}});var n}async requestSave(){return new Promise(e=>{this.coreWrapper.requestSave(!0),setTimeout(e,0)})}logAnalyticWithImageInfo(e){if(!this.imageForma)return;const t=o.ImageFacade.getImageContentForForma(this.imageForma);let n="unknown";t&&t.mediaMetadata&&t.mediaMetadata.sourceName&&(n=t.mediaMetadata.sourceName);const r=this.imageForma.isBackgroundImage()?"background":"floating";s.default.publish(e,{contextualData1:"imageSource:"+n,contextualData2:"imageType:"+r})}}m(w,"MIN_BRUSH_SIZE",1),m(w,"MAX_BRUSH_SIZE",100),m(w,"brushSizeChangeLogged",!1),m(w,"additiveBrushAppliedLogged",!1),m(w,"subtractiveBrushAppliedLogged",!1),t.default=w},FGv1:function(e,t,n){"use strict";n.r(t),n.d(t,"DCXDocumentComponentDeferred",(function(){return a}));var o=n("1tmr"),r=n("UzQk"),i=n("nNj6");class a extends o.a{constructor(e,t,n){var o,r,i;super(e,t),i=void 0,(r="params")in(o=this)?Object.defineProperty(o,r,{value:i,enumerable:!0,configurable:!0,writable:!0}):o[r]=i,this.params=n}attachToNode(){}detachFromNode(){}get absolutePath(){return""}get componentId(){return this.params.componentId||""}get content(){return this.params.content||""}get name(){return this.params.name}get path(){return this.params.path}get type(){return this.params.type}get etag(){return""}get relationship(){return this.params.relationship}get sourceHref(){return this.params.sourceHref}get mutableCopy(){return new a(this.branch,this.node,this.params)}setValue(e,t){}replaceWithReal(e){if(!e||!e.etag)return r.LegacyCoreAssert.fail("replaceWithReal: you need to pass an AdobeDCXComponent"),null;const t=new i.a(this.branch,this.node,e);return this.update(t),t}}},"I/Z9":function(e,t,n){"use strict";n.r(t),n.d(t,"createCanvas",(function(){return i})),n.d(t,"checkCanvasForAlpha",(function(){return a})),n.d(t,"trimTransparentEdges",(function(){return s})),n.d(t,"canvasToBlob",(function(){return c})),n.d(t,"renderBlobToCanvas",(function(){return u})),n.d(t,"setFullCanvasToTransparent",(function(){return h}));var o=n("qcxC"),r=n("l+ZV");function i(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const n=t.getContext("2d");return n&&n.drawImage(e,0,0),t}function a(e,t,n){const o=e.getImageData(0,0,t,n).data;for(let e=3,t=o.length;e<t;e+=4)if(0===o[e])return!0;return!1}function s(e){const t=e.width,n=e.height;let o=t,r=n,i=0,a=0;const s=e.getContext("2d");if(s){const c=s.getImageData(0,0,t,n);let u;for(let e=0;e<n;e++)for(let n=0;n<t;n++)u=4*(e*t+n),c.data[u+3]>0&&(n<o?o=n:n>i&&(i=n),e<r?r=e:e>a&&(a=e));const h=i-o+1,d=a-r+1,l=s.getImageData(o,r,h,d);e.width=h,e.height=d,s.putImageData(l,0,0)}return e}function c(e,t){const n=Object(o.deferred)();return e.toBlob?e.toBlob(e=>{n.resolve(e)},t):n.resolve(e.msToBlob()),n.promise}function u(e){const t=URL.createObjectURL(e);return r.default.load(t).then(i)}function h(e,t,n){const r=Object(o.deferred)(),i=new Image;return i.onload=()=>{const t=e.getContext("2d");if(!t)return void r.resolve();t.drawImage(i,0,0);const o=e.width,a=e.height,s=t.getImageData(0,0,o,a),u=255*n.red,h=255*n.green,d=255*n.blue,l=0===u?0:u-1,p=0===h?0:h-1,m=0===d?0:d-1;let f;for(let e=0;e<a;e++)for(let t=0;t<o;t++)f=4*(e*o+t),s.data[f+0]>=l&&s.data[f+0]<=u+1&&s.data[f+1]>=p&&s.data[f+1]<=h+1&&s.data[f+2]>=m&&s.data[f+2]<=d+1&&255===s.data[f+3]&&(s.data[f+0]=0,s.data[f+1]=0,s.data[f+2]=0,s.data[f+3]=0);t.putImageData(s,0,0),c(e).then(e=>r.resolve(e))},i.src=t,r.promise}},KpqY:function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return s}));var o=n("UzQk"),r=n("6lgp"),i=n("UFvF"),a=n.n(i);class s{static doAction(e,t){return s.doActionWithCompletion(e,t)}static doActionWithCompletion(e,t,n){if(!e||!e.controller)return a.a.reject("No document or controller");const i=a.a.defer();return e.controller.doActionWithCompletion(t,(e,t)=>{if(n)try{n(e,t)}catch(e){t||(t=e)}if(t){if(!(t instanceof r.default)){const e=t instanceof o.CoreErrorObject&&t.isAllowedError;(t=new r.default(t)).isAllowedError=e}i.reject(t)}else i.resolve(e)}),i.promise}static beginTransaction(e,t){return e.beginTransaction(t)}static endTransaction(e,t){t?e.mergeWithPrevious():e.end()}}},LI3u:function(e,t,n){var o,r=n("MOGj"),i=n("YLtl"),a=n("MGCh").channel("ManifestEncoder");function s(e,t){for(var n=0;n<e.length;n++){var o=e[n];if(o.id===t)return o}}(o=function(e,t){if(this.config=i.extend({},e),this.branch=e.branch,this.rootNode=e.rootNode||this.branch.rootNode,this.node=t||this.rootNode,this.componentBranch=e.componentBranch||this.branch,this.componentRootNode=e.componentRootNode||this.componentBranch.rootNode,this.componentNode=e.componentNode||this.node,this.isRoot=this.node==this.rootNode,this._nodes=[],this._components=[],this._stashedComponents=[],this.isRoot){var n=this.componentBranch.getComponentsOf(this.componentRootNode),o=function e(t,n,o){if(!n)return t.allComponents();o=o||[];var r=t.getComponentsOf(n);return r&&r.length>0&&(o=o.concat(r)),t.getChildrenOf(n).forEach((function(n){o=e(t,n,o)})),o}(this.componentBranch,this.componentRootNode);a.info(`stashing: begin (${o.length} components, ${o.length-n.length} not at root)`);for(var r=0;r<o.length;r++){var c=o[r];if(!s(n,c.id)){this._stashedComponents.push(c),a.info(`stashing: moving component ${c.id} to node ${this.componentRootNode.absolutePath}`);try{this.componentBranch.moveComponent(c,this.componentRootNode)}catch(e){e&&e.message.indexOf("Component not found in this branch.")>=0?this._stashedComponents.pop():a.warn(e)}}}a.info("stashing: complete"),this.config.stashedComponents=this._stashedComponents;var u=this.branch.getChildrenOf(this.node);for(a.info(`removing all ${u.length} root nodes`),r=0;r<u.length;r++){var h=u[r];this.branch.removeChild(h)}}else this._stashedComponents=this.config.stashedComponents})._implements=function(e){return"IExportDataObject"==e},o.prototype=Object.create(Object.prototype,{_implements:{value:function(e){return"IExportDataObject"===e}},setName:{value:function(e){this.node?this.node.name=e:this.branch.name=e}},setType:{value:function(e){this.node.setValue("type",e)}},setPath:{value:function(e){this.node.setValue("path",e)}},setProperty:{value:function(e,t){e.indexOf("#")<0&&(e="theo#"+e),this.node.setValue(e,t)}},setOptionalStringProperty:{value:function(e,t){t&&this.setProperty(e,t)}},setStringProperty:{value:function(e,t){this.setProperty(e,t)}},setNumberProperty:{value:function(e,t){this.setProperty(e,t)}},setIntProperty:{value:function(e,t){this.setProperty(e,t)}},setBooleanProperty:{value:function(e,t){this.setProperty(e,t)}},setOptionalBooleanProperty:{value:function(e,t){this.setProperty(e,t)}},appendChild:{value:function(e){var t=(new r.AdobeDCXBranch).addChild(null,e),n=new o(this.config,t);return this._nodes.push(n),n}},appendComponent:{value:function(e,t,n){var o={id:e,url:t,mimeType:n,confirmed:!0};this._components.push(o)}},setManifestProperty:{value:function(e,t){this.setProperty(e,t)}},setDocumentSize:{value:function(e,t){}},setCompositeID:{value:function(e){}},prepareForAttachment:{value:function(){}},finalizeAfterAttachment:{value:function(e){this.isRoot&&a.info("unstashing: begin");for(var t=0;t<this._components.length;t++){var n=this._components[t];a.assert(n.id,"finalizeAfterAttachment: A recorded component has no ID.");var o=s(this._stashedComponents,n.id),r=!1;if(this.config.finalizingComponent&&(r=this.config.finalizingComponent(e,n)),o)if(this.componentNode==this.componentRootNode);else try{var i=this.node==this.componentNode?e:this.componentNode;a.info(`unstashing: moving stashed component ${o.id} to node ${i.absolutePath}`),this.componentBranch.moveComponent(o,i)}catch(e){a.warn("moveComponent to node failed: "+e)}else a.assert(r,"finalizeAfterAttachment: no existing component, and finalizingComponent not provided or did not indicate that's OK.")}for(t=0;t<this._nodes.length;t++){var c=this._nodes[t];c.prepareForAttachment();try{var u=c.node,h=this.branch.copyChild(u,e||this.node,t,u.path,u.id);c.finalizeAfterAttachment(h)}catch(e){a.warn("addChild to node failed: "+e)}}if(this.isRoot){a.info("unstashing: complete");var d=this.componentBranch.getComponentsOf(this.componentRootNode);for(t=0;t<this._stashedComponents.length;t++){var l=s(d,(n=this._stashedComponents[t]).id);l&&(a.info("dumping unused component "+l.path),this.config.removeUnusedComponent?this.config.removeUnusedComponent(n,l):this.componentBranch.removeComponent(l))}}}}}),o.prototype.constructor=o,e.exports=o},LbXs:function(e,t,n){"use strict";let o,r;n.r(t),n.d(t,"RefineCutoutBrushMode",(function(){return o})),n.d(t,"PremiumFeature",(function(){return r})),function(e){e.ADDITIVE="additive",e.SUBTRACTIVE="subtractive",e.NONE="none"}(o||(o={})),function(e){e.BRUSH="brush",e.ERASE="erase",e.RESTORE="restore",e.INVERT="invert"}(r||(r={}))},WpJZ:function(e,t,n){"use strict";n.r(t),n.d(t,"getLockupStyleStringWithRole",(function(){return i})),n.d(t,"getAllStringForFormaUsedWheelSuggestions",(function(){return a})),n.d(t,"getUnreportedNounProjectIds",(function(){return s})),n.d(t,"setNounProjectIdsReported",(function(){return c}));var o=n("UzQk"),r=n("KpqY");function i(e,t){let n="";const r=e&&e.style;if(!r||!r.wheelUsed)return n;n=r.getCompressedStringOfFeatures();return n=`${n}{role:${(new o.RoleSuggester).getRole(e).role}|id:${e.formaID}|docId:${t.uuid}}`,n}function a(e){return e.firstPage.root.filterByControllerKind(o.TypeLockupController.KIND).map(t=>i(t,e)).filter(e=>e.length>0)}function s(e){return o.TheoDocumentUtils.getUnreportedUsedIcons(e)||[]}function c(e,t){if(!t)return;const n=r.default.beginTransaction(t,"setNounProjectIdsReported");o.TheoDocumentUtils.reportedIconUsage(t,e),r.default.endTransaction(n,!0)}},b2xK:function(e,t,n){var o,r;o=[n("YLtl"),n("UFvF")],void 0===(r=function(e,t){var n=function(e){e=e||{};var n={initialize:function(){return t.resolve(!0)},saveWithRenditions:function(e,n,o,r){return t.resolve(!0)},toTemplateLocal:function(){return t.resolve(!0)},saveImageComponent:async function(e){let t=e;if(!(e instanceof Blob)&&e.assetId){const n=await window.fetch(e.assetId);t=await n.blob()}const n=(window.URL||window.webkitURL).createObjectURL(t);return Promise.resolve({component:{id:"d34f9c8e-7789-4909-a810-7c9937cdce9e"},encodedUrl:n})},documentId:function(){return null}};return n};return n.toBlackHole=function(){return new n({})},n}.apply(t,o))||(e.exports=r)},b3Wv:function(e,t,n){var o,r;function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}o=[n("xeH2"),n("YLtl"),n("UFvF"),n("MGCh"),n("MOGj"),n("Nvgk"),n("a8ov"),n("7gWt"),n("LU24"),n("+Ltv")],void 0===(r=function(e,t,n,o,r,i,s,c,u,h){var d=s.default;const{SparkPerformanceTracker:l}=c,{PERFORMANCE_MARKERS:p}=u,{loadCPFileMark:m,loadCPCompositeMark:f}=p;var g,v,C=o.channel("cp-loader"),b={},w=window.location.protocol+"//"+window.location.host,y=w+"/api/post/v1/cp/";function D(){!g&&r.dcx&&(g=r.dcx.createHTTPService()),!v&&r.dcx&&(v=r.dcx.createCommunitySession(g,y))}function I(e){return e&&e.code&&"RETRYABLE_SERVER_ERROR"===e.code}function P(e){var t=n.defer();return r.dcx.compositeXfer.pullCompositeManifestOnly(e,v,(function(n,o){!n&&o?(e.resolvePullWithBranch(o),t.resolve(e)):t.reject(n)})),l.measurePromise(f,t.promise),t.promise}function k(e,t){var o=n.defer();return g.invoke("GET",e,{},null,t,(function(e,t){e?o.reject(e):o.resolve(t.response)})),l.measurePromise(m,o.promise),o.promise}return D(),b.loadComposite=function(e,t,n){let o;if(n)o=`${h.CP_CDN_HOST}/content/2/dcx/${e}/content/`;else{o=`${y}${t?`host/${t}/`:""}dcx/${e}/`}const s=r.dcx.newCompositeWithAssetId(o);D();let c=1;return i(P.bind(this),{maxAttempts:3,shouldRetry:I,logger:{info:function(){c++}}})(s).then((function(e){return C.debug("loadComposite succeeded after retry",{status:e.status,attempts:c}),Promise.resolve(e)})).catch(e=>{let t;return t=e instanceof Error?{message:e.message}:"object"==typeof e?a({},e):{error:e},t.attempts=c,I(e)?C.error("loadComposite gave up after all retries",t):C.error("loadComposite failed without attempting to retry",t),Promise.reject(t)})},b.loadFile=function(e,t){let n=e;d.isEncodedCPUrl(e)&&(n=d.useCpCdn?d.decodeUrl(e):`${w}${d.decodeUrl(e)}`);let o=1;return i(k.bind(this),{maxAttempts:3,shouldRetry:I,logger:{info:function(){o++}}})(n,t).then((function(e){return C.debug("loadFile succeeded after retry",{status:e.status,attempts:o}),Promise.resolve(e)})).catch(e=>{let t;return t=e instanceof Error?{message:e.message}:"object"==typeof e?a({},e):{error:e},t.attempts=o,I(e)?C.error("loadFile gave up after all retries",{error:t,cpurl:n}):C.error("loadFile failed without attempting to retry",{error:t,cpurl:n}),Promise.reject(t)})},b}.apply(t,o))||(e.exports=r)},btxu:function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return c}));var o=n("wHG3"),r=n("UzQk"),i=n("lulf"),a=n("yBTN");function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class c{static getImageQueue(){return this.pixiRenderer||(this.pixiRenderer=new o.PixiJSRenderer),this.imageQueue||(this.imageQueue=this.pixiRenderer.imageService.createQueue()),Promise.resolve(this.imageQueue)}static initialize(e){const t=!!(e=e||{}).skipLoadingAuthenticatedFeatures;if(!c.initializePromise){const e=new i.default;c.initializePromise=e.loadFeatures({skipLoadingAuthenticatedFeatures:t}).then(()=>{r.Host.setFeatureController(e)})}return c.initializePromise}static calculateTarget(e,t){let n,o;if("number"==typeof t.width&&"number"==typeof t.height)n=t.width,o=t.height;else{if("number"!=typeof t.longestSide)throw new Error("renderToCanvas missing one or more key parameters");{const r=e.bounds.width,i=e.bounds.height;n=r>i?t.longestSide:Math.round(t.longestSide*r/i),o=r>i?Math.round(t.longestSide*i/r):t.longestSide}}return{width:n,height:o}}constructor(e){s(this,"coreWrapper",void 0),s(this,"assetLoader",void 0),this.coreWrapper=e,this.assetLoader=new a.default(this.coreWrapper)}async renderToCanvas(e,t){const n=await this.commonRender(t,o.PixiJSApp.RawEncoding.AsUint8Array());e.canvas.width=n.width,e.canvas.height=n.height;const r=e.createImageData(n.width,n.height);r.data.set(n.data),e.putImageData(r,0,0)}async renderToBlob(e){const t=await this.commonRender(e,"image/png"===e.outputFormat?o.PixiJSApp.PNGEncoding.AsUint8Array():o.PixiJSApp.JPGEncoding.AsUint8Array(e.imageQuality||.75));return new Blob([t.data])}async render(e){return(await this.commonRender(e,"image/png"===e.outputFormat?o.PixiJSApp.PNGEncoding.AsDataURL():o.PixiJSApp.JPGEncoding.AsDataURL(e.imageQuality||.75))).data}async renderStack(e){return null}async commonRender(e,t){const n=e.honorDocWatermarkProp&&this.coreWrapper.getWatermarkEnabledForDoc();let r=!1,i=0;"number"==typeof e.animTime&&(i=e.animTime,r=!0);const a=this.coreWrapper.getGraph(r,n);let s;if("number"==typeof e.longestSide)s=o.PixiJSApp.TargetRenderParameters.forGraphAtSize(a,e.longestSide,t);else{if("number"!=typeof e.width||"number"!=typeof e.height)throw new Error("render params missing one or more parameters");s=o.PixiJSApp.TargetRenderParameters.fit(e.width,e.height,t)}return this.renderGraph(a,s,i)}async renderGraph(e,t,n=0){return(await c.getImageQueue()).render(e,t,n,this.assetLoader)}}s(c,"pixiRenderer",void 0),s(c,"imageQueue",void 0),s(c,"initializePromise",void 0)},hEO4:function(e,t,n){var o,r;o=[n("MGCh"),n("UzQk")],void 0===(r=function(e,t){const n=e.channel("Diagnostics"),o={truncateEncodedDOM:function(e){const t=["theo#placement","theo#bounds","theo#style","theo#color-library","theo#saliency-data","theo#artwork","theo#image-color-data","theo#edge-data"],n=["type-lockup"];return function e(o){const r={},i=o["theo#controller-kind"];try{Object.keys(o).forEach(a=>{let s=o[a];t.indexOf(a)>=0?s=`…${JSON.stringify(s).length}…`:"children"===a?s=i&&n.indexOf(i)>=0?`…${JSON.stringify(s).length}…`:s.map(t=>e(t)):"string"==typeof s&&(s=s.replace(/(.{8})-.{4}-.{4}-.{4}-.{12}/g,"$1…")),r[a]=s})}catch(e){r.error="threw "+e}return r}(e)},validateDOM:function(e){try{if(!e.children)return"no root children";4!==e.children.length&&n.warn("expected 4 root children");const t=e.children.find(e=>"forma-document"===e.path);if(!t)return"no forma document";if("application/vnd.adobe.theo.forma+dcx"!==t.type&&n.warn("forma doc did not have correct type",t.type),!t.children||1!==t.children.length)return"expected exactly one forma root";const o=t.children[0];if("Root"!==o["theo#kind"])return"root forma did not have kind Root";if("root"!==o["theo#controller-kind"])return"root forma did not have controller kind root";if(!o.children||0===o.children.length)return"root forma did not have children";if(window.simulate_bad_dom){delete o.children.find(e=>"group"===e["theo#kind"]&&"grid"===e["theo#controller-kind"])["theo#controller-kind"]}const r=o.children.find(e=>"group"===e["theo#kind"]&&"grid"===e["theo#controller-kind"]);if(!r)return"root forma did not have a grid child";if(!r.path)return"grid is missing path property"}catch(e){return"validation threw: "+e}return null},findGrid:function(e){if(!e)return n.error("findGrid: document is null"),null;const t=e.firstPage.root;if(!t||0===t.childCount)return n.error("findGrid: root has no children"),null;const o=t.children_.find(e=>"group"===e.kind&&e.controller&&"grid"===e.controller.kind);return o||(1===t.children_.length?(n.error("findGrid: assuming the sole child of the root is the grid; it's not the correct kind"),t.children_[0]):(n.error("findGrid: root unexpectedly had more than one child and none looked like a grid"),null))},dumpPostDOM:function(e){return function e(n){try{const o={id:n.formaID,kind:n.kind},r=n.controller;if(r&&(o.ckind=r.kind),n instanceof t.GroupForma){const r=n.visitAsArray(t.FormaTraversal.JustChildren);o.children=r.map(t=>e(t))}return o}catch(e){return{error:"threw"+e}}}(e.firstPage.root)},dumpStateDelta:function(e,t,n){t=t||10,n=n||1e4;const o=[];try{const r=e.database;let i=0,a=r.currentState.state;for(;a&&i<t;){const e={guid:a.guid,gen:a.generation_};try{e.deltas=Object.keys(a.objectStates).map(e=>{const t=a.objectStates[e];return{id:e,cls:t.className,props:Object.keys(t.properties||{}).join(",")}})}catch(t){e.error="threw "+t}if(o.push(e),JSON.stringify(o).length>n&&(e.summary=e.deltas.length+" objects mutated",delete e.deltas,JSON.stringify(o).length>n)){o.pop();break}a=a.basedOn,i++}}catch(e){o.push({error:"state enumeration threw "+e})}return o},dumpUndoRedo:(e,t)=>{t=t||80;const n={states:[]};try{e.controller.undoRedoMgr.timeline.states.forEach(e=>{const o={};e.action&&(o.action=e.action.description),e.state&&e.state.state&&(o.guid=e.state.state.guid),e.beginSelectedFormaIDs&&(o.bfids=e.beginSelectedFormaIDs.concat()),e.endSelectedFormaIDs&&(o.efids=e.endSelectedFormaIDs.concat()),n.states.push(o),n.states.length>t&&n.states.shift()})}catch(e){n.error="throw: "+e}return n},snapshotFormaHistory:(e,t)=>{if(!t)return{error:"nil object"};const n=[];try{let o=t.state;for(;o;){const r={};Object.keys(o.properties).forEach(e=>{const t=o.properties[e];t.isArray?r[e]=`array(${t.value.length})`:t.isDictionary?r[e]=`object(${Object.keys(t.value).join(",")})`:r[e]=`${t.schemaType}(${t.value})`});const i=[];let a=e.database.currentState.state;for(;a;)a.objectStates[t.id]===o&&i.push(a),a=a.basedOn;n.push({props:r,dbStates:i.map(e=>e.guid)}),o=o.basedOn}}catch(e){n.push("throw "+e)}return{kind:t.kind,id:t.formaID,ckind:t.controller?t.controller.kind:"no controller",states:n}},monitorTransactionsForDocument:function(e){const t=[];let r=!1;const i=(e,o)=>{try{r=!0;const i={msg:e,recent:t.concat()};void 0!==o&&(i.err=o);try{throw new Error}catch(e){i.stack=e.stack}n.error("grid validation failed",i)}catch(e){n.error("monitorTransactionsForDocument throw",e)}},a=n=>{try{if(r)return;if(t.push({event:n,history:o.snapshotFormaHistory(e,e.firstPage.root.childAt(0))}),t.length>10&&t.shift(),window.simulate_db_validation_failure)i("simulated failure"),r=!1;else if(1!==e.firstPage.root.childCount)i(`root has ${e.firstPage.root.childCount} children`);else{const t=e.firstPage.root.childAt(0);"group"!==t.kind?i("grid has kind "+t.kind):t.controller?"grid"!==t.controller.kind&&i("grid has controller kind "+t.controller.kind):i("grid has kind "+t.kind)}}catch(n){i("throw validating",n)}};e.database.addListener({onBeginTransaction:(e,t)=>a("beginT "+t.name),onEndTransaction:(e,t)=>a("endT "+t.name),onStateChanged:(e,t)=>{},onObjectStateChanged:(e,t)=>{}})}};return o}.apply(t,o))||(e.exports=r)},hxdN:function(e,t,n){"use strict";var o=n("X4BD"),r=n("VpTX");function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class a{constructor(){i(this,"_width",0),i(this,"_height",0),i(this,"_started",!1),i(this,"drawer",null),i(this,"brushProps",{red:0,green:0,blue:0,brushSize:20,brushFlow:1,brushNoise:0,brushSpacing:.25,opacity:1,linearity:3,hardness:.85}),i(this,"brushPreview",null),i(this,"offscreenCanvas",null)}get width(){return this._width}get height(){return this._height}get started(){return this._started}async init(){return a.loadPromise}async setSize(e,t){if(this._width===e&&this._height===t)return!1;this._width=e,this._height=t;const n=await this.init();return n&&(this.drawer&&n.destroy(this.drawer),this.drawer=new n.Draw(e,t,!0,!1),this._started=!1,this.loadBrush(a.BRUSH_SIZE,this.brushProps.hardness)),!0}async drawAt(e,t,n){if(!this._width||!this._height)throw Error("Size not set");if(await this.init(),!this.drawer)throw Error("Drawer not ready?");this._started=!0,this.drawer.start(e,t,this.brushProps.brushSize,this.brushProps.brushFlow,this.brushProps.brushNoise,this.brushProps.brushSpacing,this.brushProps.red,this.brushProps.green,this.brushProps.blue,this.brushProps.opacity,this.brushProps.linearity,n||(new Date).getTime())}async drawTo(e,t,n){if(await this.init(),!this.drawer)throw Error("Drawer not ready?");this._started||await this.drawAt(e,t,n),this.drawer.markTo(e,t,this.brushProps.brushSize,this.brushProps.brushFlow,this.brushProps.brushNoise,this.brushProps.brushSpacing,n||(new Date).getTime())}async updateCanvas(e,t,n){if(!this._width||!this._height)return Promise.reject(Error("Size not set"));const o=await this.init();if(!this.drawer)throw Error("Drawer not ready?");const r=this.drawer.getImageBuffer(),i=new Uint8ClampedArray(o.HEAPU8.buffer,r,this.drawer.get_imageBufferSize());await this.renderToContext(e,i,t,n)}async renderToContext(e,t,n,o){const r=e.createImageData(this._width,this._height),i=void 0===n?this._width:n,a=void 0===o?this._height:o;if(r.data.set(t),"createImageBitmap"in window){const t=await createImageBitmap(r);e.drawImage(t,0,0,this._width,this._height,0,0,i,a)}else{this.offscreenCanvas||(this.offscreenCanvas=document.createElement("canvas")),this.offscreenCanvas.width=r.width,this.offscreenCanvas.height=r.height;const t=this.offscreenCanvas.getContext("2d");t&&(t.putImageData(r,0,0),e.drawImage(this.offscreenCanvas,0,0,this._width,this._height,0,0,i,a))}}clear(){this.drawer&&this.drawer.resetCanvas(),this.offscreenCanvas&&(this.offscreenCanvas.width=0,this.offscreenCanvas.height=0,this.offscreenCanvas=null)}async destroy(){this.clear(),this.drawer&&await this.init().then(e=>{e.destroy(this.drawer),this.drawer=null})}setBrushSize(e){const t=Math.max(1,Math.floor(e));return this.brushProps.brushSize!==t&&(this.brushProps.brushSize=t),t}setBrushColor(e){this.brushProps.red=e.red,this.brushProps.green=e.green,this.brushProps.blue=e.blue}async loadBrush(e,t){const n=Math.floor(e/2),o=await this.init();if(!this.drawer)throw Error("Drawer not ready?");const r=o._malloc(e*e),i=new Uint8Array(o.HEAPU8.buffer,r,e*e);for(let i=0;i<e;i+=1)for(let a=0;a<e;a+=1){const s=a+i*e,c=a-n,u=i-n,h=Math.sqrt(c*c+u*u)/n;let d=0;h>1?d=1:(d=h>=t?(h-t)/(1-t):0,d*=2,d=1-Math.max(0,Math.E**-(d**2.4)));let l=(1-d)*(1-0*this.getRandom())*255;const p=l-Math.floor(l);l=Math.floor(l)+(this.getRandom()<p?1:0),o.HEAPU8[r+s]=l}this.drawer.loadBrush(e,e,i.byteOffset),o._free(r)}getRandom(){return Math.random()}}i(a,"BRUSH_SIZE",100),i(a,"loadPromise",new Promise(e=>{Object(o.a)({locateFile:()=>r.a}).then(e)})),t.a=a},mwMu:function(e,t,n){var o,r;o=[n("YLtl"),n("UFvF"),n("2ofD"),n("MGCh"),n("a8ov"),n("UzQk"),n("r3b0"),n("14LO")],void 0===(r=function(e,t,n,o,r,i,a,s){var c=r.default,u=s.DCXDocumentComposite,h=o.channel("SourceCCStorage"),d=["id","local","manifest-format-version","name","projectContext#npwMethod","state","type","authctx#ctxid"],l=function(e){var o={},r=(e=e||{}).dcxDoc||n.currentDoc,s=e.branch||r.getDCXComposite().current,l=e.rootNode||s.root,p=e.domComponentPath;return o.open=function(){return(p?r.getComponent(l.absolutePath+"/"+p).then((function(e){var t,n=JSON.parse(e),o=new a({makeComponentUrl:function(e){return c.encodeComponentUrl(r.id,e.id,e.type)},manufactureComponentsForNode:function(e){var t=e&&e["theo#external-url"];return t?[{id:i.GUIDUtils.makeGUID(),url:t,mimeType:e["theo#mimetype"]}]:null},trackAbsolutePath:!0,branch:n});try{t=new i.TheoDocument.newDocumentFromDataObject(o,(function(e){const t=e&&"function"==typeof e.join?e.join(";"):"No error array found for err: "+e;throw new Error(t)})),i.TheoDocumentUtils.createImageFeatures(t),t.history.postEntry("open,src=AC,was-vers="+t.versionDecoded.rawValue),l.name&&(t.documentName=l.name)}catch(e){throw h.error("acOpen",e),t=i.TheoDocument.createDefault(r.id),e}return t})):s===r.getDCXComposite().current?function(){var e,n,o=r.getDCXRoot();if(o._data.children)e=new u({composite:r.getDCXComposite()});else{for(var a in o._data)o._data.hasOwnProperty(a)&&-1===d.indexOf(a)&&console.error("unexpecte property: "+a+" found when creating a new doc.");e=null}n=e&&e.current;let s=t.resolve();return n&&i.DocumentPersistenceFactory.usesJsonDocumentEncoding(n)&&(s=s.then(()=>{const e=i.JSONDocumentDecoder.getRequiredSynchronousComponents(n);return t.all(e.map(e=>r.getComponent(e).then((function(t){var o=JSON.parse(t);n.registerContentForComponent(e,o)}))))})),s.then(()=>{var t;try{e?(t=i.TheoDocument.decodeDocument(e,(function(e){throw n.releaseRegisteredContent(),new Error(e.join(";"))})),i.TheoDocumentUtils.createImageFeatures(t)):t=i.TheoDocument.createDefault(r.id),n&&n.releaseRegisteredContent(),t.history.postEntry("open,src=CC,was-vers="+t.versionDecoded.rawValue)}catch(e){throw h.error("coreOpen",e),e}return t})}():function(){var e,n=s._data,o=new a({makeComponentUrl:function(e){return c.encodeComponentUrl(r.id,e.id,e.type)},trackAbsolutePath:!1,branch:n,rootNode:l});try{e=new i.TheoDocument.newDocumentFromDataObject(o,(function(e){throw new Error(e.join(";"))})),i.TheoDocumentUtils.createImageFeatures(e)}catch(e){return h.error("decoding from nodes",e),t.reject(e)}return t.resolve(e)}()).then(e=>e)},o.documentId=function(){return r.id},o};return l.fromDocument=function(e){return new l({dcxDoc:e})},l.fromTemplate=function(e,t){return new l({dcxDoc:e.composite,rootNode:t,domComponentPath:"dom.json"})},l}.apply(t,o))||(e.exports=r)},nNj6:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var o=n("UzQk"),r=n("1tmr");class i extends r.a{constructor(e,t,n){var o,r,i;super(e,t),i=void 0,(r="dcxComponent")in(o=this)?Object.defineProperty(o,r,{value:i,enumerable:!0,configurable:!0,writable:!0}):o[r]=i,this.dcxComponent=n}attachToNode(){if(this.branch.dcxBranch.getComponentsOf(this.node.dcxNode).indexOf(this.dcxComponent)<0)try{this.branch.dcxBranch.moveComponent(this.dcxComponent,this.node.dcxNode)}catch(e){o.LegacyCoreAssert.fail("attachToNode: moveComponent() failed",e)}}detachFromNode(){this.branch.dcxBranch.getComponentsOf(this.node.dcxNode).indexOf(this.dcxComponent)>=0&&this.branch.retireComponent(this.dcxComponent)}get absolutePath(){return this.dcxComponent.absolutePath||""}get componentId(){return this.dcxComponent.id||""}get name(){return this.dcxComponent.name}get path(){return this.dcxComponent.path}get type(){return this.dcxComponent.type}get etag(){return this.dcxComponent.etag}get relationship(){return this.dcxComponent.relationship}get sourceHref(){return null}get mutableCopy(){return new i(this.branch,this.node,this.dcxComponent)}setValue(e,t){this.dcxComponent.setValue(e,t)}}},qcxC:function(e,t,n){"use strict";function o(){let e,t;return{promise:new Promise((n,o)=>(e=n,t=o)),resolve:e,reject:t}}n.r(t),n.d(t,"deferred",(function(){return o})),t.default=o},qnb0:function(e,t,n){var o,r;o=[n("YLtl"),n("UFvF"),n("MOGj"),n("2ofD"),n("MGCh"),n("a8ov"),n("UzQk"),n("b3Wv"),n("7the"),n("LI3u"),n("bBG2"),n("uTW7"),n("FGv1"),n("hEO4")],void 0===(r=function(e,t,n,o,r,i,a,s,c,u,h,d,l,p){const m=i.default,f=h.default;var g=r.channel("SaveCCStorage"),v=function(e,t){var n=e&&e.absolutePath;return n&&"/"!==n?n+"/"+t:"/"+t},C=function r(i){var h={},C=(i=i||{}).dcxDoc||o.currentDoc,b=i.branch||C.getDCXComposite().current,w=i.rootNode||b.rootNode,y=i.domComponentPath,D=i.isAuthoringContext||!!y,I=i.copyExternalImages,P=i.commitChanges||r.CommitChanges.AUTO,k=b.addElement("retirement","foo","retirement"),x=b.getChildWithAbsolutePath("/retirement");b.removeChild(x);var S={};function A(e,t){return`${e}:${t}`}var E=[];function F(e,n){var o=D?e:e+".jpg";g.info("saving rendition "+o);var r=v(w,o);return C.pushComponentWithRetry({name:e,path:o,absolutePath:r,isUpdate:E.indexOf(r)>=0,relationship:"rendition",file:n,type:n.type,parent:w}).then((function(e){return g.info("finished saving rendition "+o),e})).catch((function(e){return g.error("error while saving image rendition",e),f.publish("post:saveCCStorageAttempt",{contextualData1:"path:"+o,contextualData2:"success:"+!1}),t.reject(e)}))}function U(){var e=b.getChildWithAbsolutePath(v(w,"assets"));return e||((e=b.addChild(void 0,void 0,0,w)).path="assets"),e}function N(e,o,i){g.info("legacyACSave: begin"),g.assert(i,"legacyACSave: expected a thumbnail rendition"),g.assert(y,"legacyACSave: expect to get here only with a domComponentPath"),g.assert(D,"legacyACSave: expect to get here only for legacy AC saving");var s,c=[],h=C.getDCXComposite().current,d={finalizingComponent:function(e,t){var n=S[A(t.id,t.url)]||t.url;return m.isEncodedCPUrl(n)||m.isEncodedAuthoringContextUrl(n)||(n.indexOf("theo-web/images")>=0?g.warn("legacyACSave: recording this url as external",n):g.error("legacyACSave: recording this url as external",n)),e.setValue("theo#external-url",n),!0},removeUnusedComponent:function(e,t){k.getComponentWithId(t.id)?g.info(`not retiring component ${t.id} because we already have a`):(g.info("retiring component "+t.id),k.copyComponent(t)),h.removeComponent(t)}};s=new n.AdobeDCXBranch,d.branch=s,d.componentBranch=h,d.componentRootNode=w,d.componentNode=U();try{g.info("encoding composite"),e.history.postEntry("save,dst=AC");var l=new u(d);e.encode(l),l.prepareForAttachment(),l.finalizeAfterAttachment()}catch(e){throw g.error("error during encoding",e),err}const p=[];return o&&c.push(F("preview",o).then((function(e){p.push(e)}))),i&&c.push(F("thumbnail",i).then((function(e){p.push(e)}))),s&&c.push(function(e,n,o){g.info("saving dom "+n);var r=v(w,n);return C.pushComponentWithRetry({name:e,path:n,absolutePath:r,isUpdate:E.indexOf(r)>=0,relationship:"dom",type:"application/vnd.adobe.adobesparkpost.dom+json",file:JSON.stringify(o),parent:w}).then((function(e){return g.info("finished saving dom "+n),e})).catch((function(e){return g.error("error while saving dom",e),f.publish("post:saveCCStorageAttempt",{contextualData1:"path:"+n,contextualData2:"success:"+!1}),t.reject(e)}))}("dom",y,s._data)),t.all(c).then((function(){w.setValue("theo#last-modified",(new Date).toISOString());var n=e.documentName;return w.name=n===a.TheoDocument.DEFAULT_NAME?"":n,O(p),P===r.CommitChanges.NEVER?(g.info("legacyACSave: complete; not saving, per client"),t.resolve()):(g.info("legacyACSave: saving changes"),C.saveChanges((function(){})).then(()=>g.info("legacyACSave: complete")))}))}function O(t){e.each(e.filter(C.getDCXComposite().current.getComponentsOf(w),(function(e){return"rendition"===e.relationship&&t.indexOf(e)<0})),(function(e){g.info("removing stale rendition component",e.id),C.getDCXComposite().current.removeComponent(e)}))}function R(e,o,i,s){g.info("coreSave() begin");var c=new d.DCXDocumentBranch({branch:C.getDCXComposite().current,retiredElement:k}),u=a.DocumentPersistenceFactory.encoderFor(c);try{"string"==typeof s?e.encodeStateByID(s,u):e.encode(u),u.finish()}catch(e){throw g.error("coreSave() threw during encoding process",e),e}const h=[],m=[],b=c.getDeferredComponents(),w=b.find(e=>"dom"===e.relationship);if(w){const n=w.params.content,o=p.validateDOM(n);if(o){g.error(`validation failure '${o}'; encoded=`,p.truncateEncodedDOM(n)),g.error(`validation failure '${o}'; document=`,p.dumpPostDOM(e)),g.error(`validation failure '${o}'; delta=`,p.dumpStateDelta(e)),g.error(`validation failure '${o}'; undoredo=`,p.dumpUndoRedo(e));const r=p.findGrid(e);return g.error(`validation failure '${o}'; gridhist=`,p.snapshotFormaHistory(e,r)),t.reject(o)}}const y=c.root&&c.root.dcxNode;if(y)try{const e=JSON.stringify(y._data);(new n.AdobeDCXBranch).parse(e)}catch(n){return g.error(`manifest validation failure '${n}'; encoded=`,p.truncateEncodedDOM(dom)),g.error(`manifest validation failure '${n}'; document=`,p.dumpPostDOM(e)),g.error(`manifest validation failure '${n}'; delta=`,p.dumpStateDelta(e)),g.error(`manifest validation failure '${n}'; undoredo=`,p.dumpUndoRedo(e)),t.reject(n)}return b.forEach(e=>{h.push(function(e){g.assert(e instanceof l.DCXDocumentComponentDeferred);var n=e.params,o=v(n.node,n.path);return g.info(`saving deferred component ${n.name} at ${o}`),C.pushComponentWithRetry({name:n.name,path:n.path,absolutePath:o,isUpdate:E.indexOf(o)>=0,relationship:n.relationship,file:JSON.stringify(n.content),type:n.type,parent:n.node.dcxNode}).then((function(t){return g.info("finished saving component "+n.path),e.replaceWithReal(t),t})).catch((function(e){return g.error("error while saving component",e),f.publish("post:saveCCStorageAttempt",{contextualData1:"path:"+o,contextualData2:"success:false"}),t.reject(e)}))}(e))}),o&&h.push(F("preview",o).then((function(e){m.push(e)}))),i&&h.push(F("thumbnail",i).then((function(e){m.push(e)}))),g.info(`coreSave waiting on ${h.length} asynchronous operations`),t.all(h).then(()=>(C.setName(e.documentName),O(m),P==r.CommitChanges.NEVER?t.resolve():(g.info("coreSave: requesting doc.saveChanges()"),C.saveChanges((function(){}))))).then(()=>{g.info("coreSave() finished")})}return h.initialize=function(){return t.resolve(!0)},h.documentId=function(){return C.id},h.saveImageComponent=function(e,n,o,r,i){n=n||"image/jpeg",o=o||U();var s="";"image/jpeg"===n?s=".jpg":"image/png"===n?s=".png":"image/svg"!==n&&"image/svg+xml"!==n||(s=".svg");var c=a.GUIDUtils.makeGUID()+s,u={name:i||"image",relationship:"image",type:n,path:c,absolutePath:v(o,c),parent:o};return r&&(u.id=r),e instanceof Blob?u.file=e:(u.copyFrom={source:e.source,assetId:e.assetId},e.source||g.error("save-ccstorage saveImageComponent imageFile.source is falsy, assetId:  "+e.assetId)),g.info("pushing component "+c),C.pushComponentWithRetry(u).then((function(e){return g.info("pushed component "+c),{component:e,encodedUrl:D?m.encodeAuthoringContextUrl(C.id,e.id,null,n):m.encodeComponentUrl(C.id,e.id,n)}})).catch((function(e){return g.error("save-ccstorage saveImageComponent failed with",e),f.publish("post:saveCCStorageAttempt",{contextualData1:"path:"+c,contextualData2:"success:"+!1}),t.reject(e)}))},h.saveWithRenditions=function(n,o,r,i){var u,d=n.beginTransaction("prune_orphaned_content");return a.TheoDocumentUtils.pruneOrphanedContent(n),d.end(),u=C.getDCXComposite().current.allComponents()||[],E=u.map(e=>e.absolutePath),(I?function(n){const o=[];return n.content.root.visitAll((function(e){e instanceof a.URLBasedContentNode&&o.push(e)})),t.all(e.map(o,(function(e){let t=e.url;if(!t||!e.componentID){const n=e instanceof a.VectorContentNode;return g.assert(n||t,"doCopyExternalImages: should have a valid url"),g.assert(n||e.componentID,"doCopyExternalImages: should have a valid componentID"),null}t=S[A(e.componentID,t)]||t,t!=e.url&&g.info(`doCopyExternalImages: applying domain-map of ${e.url} to ${t}`);let n=null;if(m.isEncodedCPUrl(t))"all"===I?(g.info(`pulling CP image ${t} for componentID ${e.componentID}`),n=s.loadFile(t,{responseType:"blob"})):g.info(`not pulling CP image ${t} because caller didn't ask us to`);else if(m.isEncodedAuthoringContextUrl(t)){m.decodeAuthoringContextUrlParameters(t).assetId!==C.id?(g.info("pulling AC image",t),n=c.loadFile(t,{responseType:"blob"})):g.info(`not pulling AC image ${t} because it's already in this AC`)}else if(m.isEncodedComponentUrl(t)){const e=m.decodeComponentUrlParameters(t);e.docId!==C.id&&(t=m.encodeComponentUrl(e.docId,e.componentId,e.mimeType),g.info("pulling doc image "+t),n=c.loadFile(t,{responseType:"blob"}))}if(n)return n.then((function(n){return g.info("pushing pulled image",t),h.saveImageComponent(n,e.mimeType,U(),e.componentID,e.componentID)})).then((function(t){return g.assert(t.component.id===e.componentID),g.info(`image pushed as component id ${t.component.id}; aliasing from ${e.url} to ${t.encodedUrl}`),S[A(e.componentID,e.url)]=t.encodedUrl,null})).catch((function(e){g.error("error while saving dom",e)}))}))).catch((function(e){throw g.error("error while copying images",e),e}))}(n):t.resolve(null)).then((function(){if(!o){var e=v(w,"preview.jpg"),t=C.getComponentWithAbsolutePath(e);t&&C.removeComponent(t)}return D?N(n,o,r):R(n,o,r,i)}))},h};return C.CommitChanges={AUTO:"AUTO",NEVER:"NEVER"},C.toDocument=function(e){return new C({dcxDoc:e,copyExternalImages:"all",commitChanges:C.CommitChanges.AUTO})},C.toTemplateLocal=function(e,t,n){return new C({dcxDoc:e.composite,rootNode:t,domComponentPath:"dom.json",commitChanges:n})},C.toTemplateExternal=function(e,t,n){return new C({dcxDoc:e.composite,rootNode:t,domComponentPath:"dom.json",copyExternalImages:"template",commitChanges:n})},C}.apply(t,o))||(e.exports=r)},r3b0:function(e,t,n){var o,r;!function(){function e(){for(var e=[],t=0;t<36;t++)e[t]="0123456789abcdef".substr(Math.floor(16*Math.random()),1);return e[14]="4",e[19]="0123456789abcdef".substr(3&e[19]|8,1),e[8]=e[13]=e[18]=e[23]="-",e.join("")}function t(e,t){return e=e||"/",t?("/"!=e.substring(e.length-1)&&(e+="/"),e+t):e}(r=function(t,n){this.config=t,this.branch=t.branch,this.node=n,t.remix&&(this.node?this.node.id=e():this.branch.id=e())})._implements=function(e){return"IImportDataObject"==e},r.prototype=Object.create(Object.prototype,{id:{get:function(){return this.node?this.node.id:this.branch.id}},type:{get:function(){return this.node?this.node.type:this.branch.type}},name:{get:function(){return this.node?this.node.name:this.branch.name}},path:{get:function(){return this.node?this.node.path:this.branch.path}},property:{value:function(e){return e.indexOf("#")<0&&(e="theo#"+e),this.node?this.node[e]:this.branch[e]}},stringProperty:{value:function(e,t){var n=this.property(e);return null==n?t:n}},numberProperty:{value:function(e,t){var n=this.property(e);return null==n?t:n}},intProperty:{value:function(e,t){var n=this.property(e);return null==n?t:n}},booleanProperty:{value:function(e,t){var n=this.property(e);return null==n?t:n}},optionalBooleanProperty:{value:function(e){return this.property(e)}},optionalStringProperty:{value:function(e){return this.property(e)}},forEachChild:{value:function(e){var n=this.node?this.node.children:this.branch.children;if(n)for(var o=0;o<n.length;o++){var i=n[o];this.config.trackAbsolutePath&&(i.absolutePath=t(this.node?this.node.absolutePath:null,i.path)),e(new r(this.config,i),o)}}},forEachComponent:{value:function(e){var n=this.node?this.node.components:this.branch.components;if(n)for(var o=0;o<n.length;o++){var r=n[o];this.config.trackAbsolutePath&&(r.absolutePath=t(this.node?this.node.absolutePath:null,r.path)),e({id:r.id,mimeType:r.type,url:this.config.makeComponentUrl(r)},o)}if(this.config.manufactureComponentsForNode){var i=this.config.manufactureComponentsForNode(this.node);if(i)for(o=0;o<i.length;o++)e(i[o],(n?n.length:0)+o)}}}}),r.prototype.constructor=r}(),void 0!==e.exports?e.exports=r:void 0===(o=function(){return r}.apply(t,[]))||(e.exports=o)},tWZ4:function(e,t,n){"use strict";var o;n.r(t),function(e){e.IMAGE_LOADING="image-loading",e.ANIMATION_LOADING="animation-loading",e.BADGE_LOADING="badge-loading",e.ACTION_FEEDBACK="action-feedback",e.REFINE_CUTOUT_OP="refine-cutout-op",e.OVERRIDE_ALL="override-all"}(o||(o={})),t.default=o},uTW7:function(e,t,n){"use strict";n.r(t),n.d(t,"DCXDocumentBranch",(function(){return f}));var o=n("UzQk"),r=n("MGCh"),i=n.n(r),a=n("a8ov"),s=n("A+mC"),c=n("1tmr"),u=n("FGv1"),h=n("nNj6");function d(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class l{constructor(e,t,n){d(this,"overrideID",void 0),d(this,"dcxNode",void 0),d(this,"parent",void 0),d(this,"branch",void 0),d(this,"childNodes",void 0),d(this,"childComponents",void 0),this.dcxNode=e,this.branch=t,this.parent=n,this.overrideID=t.getOverrideIDForNode(e),this.childNodes=t.dcxBranch.getChildrenOf(this.dcxNode).map(e=>new l(e,t,this)),this.childComponents=t.dcxBranch.getComponentsOf(this.dcxNode).map(e=>new h.a(t,this,e))}get absolutePath(){return this.dcxNode.absolutePath}get nodeId(){return this.overrideID||this.dcxNode.id}get name(){return this.dcxNode.name}set name(e){this.dcxNode.name=e}get path(){return this.dcxNode.path}set path(e){this.dcxNode.path=e}get type(){return this.dcxNode.type}set type(e){this.dcxNode.type=e}getValue(e){return this.dcxNode.getValue(e)}setValue(e,t){e!==o.PROPERTY_KEY_ID&&this.dcxNode.setValue(e,t)}removeValue(e){this.dcxNode.removeValue(e)}visit(e){let t=e(this);if(t)return t;for(let n=0;n<this.childNodes.length;n++)if(t=this.childNodes[n].visit(e),t)return t;return null}findComponent(e){return this.visit(t=>t.childComponents.find(t=>e(t))||null)}findNode(e){return this.visit(t=>e(t)?t:null)}setCompositeID(e){}setManifestProperty(e,t){}setDocumentSize(e,t){}}function p(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const m=i.a.channel("DCXDocumentBranch");class f{constructor(e){p(this,"dcxBranch",void 0),p(this,"_root",void 0),p(this,"_retiredElement",void 0),p(this,"_componentPaths",{}),p(this,"_componentURLfn",void 0),p(this,"_overrideIDfn",void 0),this.dcxBranch=e.branch,this._retiredElement=e.retiredElement||null,this._componentURLfn=e.componentURLfn||null,this._overrideIDfn=e.overrideIDfn||null,this._root=new l(e.branch.rootNode,this,null)}getOverrideIDForNode(e){return this._overrideIDfn&&this._overrideIDfn(e)}registerContentForComponent(e,t){this._componentPaths[e]=o.Host.persistUtils.writeJsonContentToTempFile(t)}releaseRegisteredContent(){if(o.Host.persistUtils instanceof s.HostPersistUtilsImpl)for(const e in this._componentPaths)o.Host.persistUtils.deleteTempFile(this._componentPaths[e]);else o.Host.logging.warning("persist utils is not of a known type; releasing temp files won't happen");this._componentPaths={}}getDeferredComponents(){const e=[];return this._root.visit(t=>e.push.apply(e,t.childComponents.filter(e=>e instanceof u.DCXDocumentComponentDeferred))),e}get root(){return this._root}getValue(e){return this.dcxBranch.rootNode.getValue(e)}setValue(e,t){e===o.PROPERTY_KEY_NAME?this.dcxBranch.name=t:this.dcxBranch.rootNode.setValue(e,t)}get allComponents(){const e=[];return this._root.visit(t=>{e.push.apply(e,t.childComponents)}),e}appendNode(e,t,n){if(e=e||o.GUIDUtils.makeGUID(),!n||n instanceof l){const o=n||this._root,r=this.dcxBranch.addChild("",e,void 0,o.dcxNode);t&&(r.path=t);const i=new l(r,this,o);return o.childNodes.push(i),i}return m.error("appendNode: foreign node"),null}removeNode(e){if(e instanceof l)if(e.branch!==this)m.error("trying to remove a node from a branch it doesn't belong to");else if(e.parent){const t=e.parent.childNodes.indexOf(e);t<0?m.error("trying to remove a node from a parent it doesn't belong to"):(e.visit(e=>e.childComponents.forEach(e=>{e instanceof h.a&&this.retireComponent(e.dcxComponent)})),e.parent.childNodes.splice(t,1),this.dcxBranch.removeChild(e.dcxNode))}else m.error("can't remove the root node");else m.error("trying to remove a node that isn't really a node")}getChildrenOfNode(e){return o.LegacyCoreAssert.isTrue(!e||e instanceof l,"node must be null or a DCX Document node"),e instanceof l?e.childNodes.concat():this._root.childNodes.concat()}getComponentsOfNode(e){return o.LegacyCoreAssert.isTrue(!e||e instanceof l,"node must be null or a DCX Document node"),e instanceof l?e.childComponents.concat():this._root.childComponents.concat()}getComponentWithId(e){return this._root.findComponent(t=>t.componentId===e)}getPathForComponent(e){if(e instanceof c.a){const t=this._componentPaths[e.absolutePath];if(t)return t;if(this._componentURLfn){const t=this._componentURLfn(e);if(null!==t)return t}return o.LegacyCoreAssert.isTrue(!!e.componentId&&!!e.type,"missing component id or type"),a.default.encodeComponentUrl(this.root.nodeId,e.componentId,e.type)}return m.error("passed in component isn't our type of component"),null}getComponentWithAbsolutePath(e){return this._root.findComponent(t=>t.absolutePath===e)}getNodeWithAbsolutePath(e){return this._root.findNode(t=>t.absolutePath===e)}addComponent(e,t,n,r,i,a,s,c,d){const p=a instanceof l?a.dcxNode:this.dcxBranch.rootNode,f=a&&a instanceof l?a:this._root;if(this._retiredElement){const e=this._retiredElement.getComponentsOf(this._retiredElement.rootNode).find(e=>e.id===t);if(e){m.info(`copying component ${e.id} from retirement zone`),this.dcxBranch.copyComponent(e,p);const t=new h.a(this,f,e);return f.childComponents.push(t),t}}if(s&&o.Host.persistUtils&&o.Host.persistUtils.fileExists(s)){m.info(`creating deferred content component for ID ${t} from source ${s}`);const a={name:e,type:n,relationship:r,path:i,sourceFile:s,copy:c,sourceHref:d,componentId:t||"",node:f,content:o.Host.persistUtils.readJsonContentFromFile(s)},h=new u.DCXDocumentComponentDeferred(this,f,a);return f.childComponents.push(h),h}return m.error("addComponent: on web we can't add arbitrary components.."),null}moveComponent(e,t){return e instanceof c.a?(m.info(`moveComponent ${e.componentId} to node ${t instanceof l?t.absolutePath:"root"}`),e.reparent(t||this._root),e):(m.error("updateComponent: requires a DCXDocumentComponent"),null)}retireComponent(e){this._retiredElement?"rendition"!==e.relationship&&"dom"!==e.relationship?this._retiredElement.allComponents().find(t=>t.id===e.id)?m.info(`not retiring component ${e.id} (already have a copy of it in retirement zone)`):(m.info("retiring "+e.id),this._retiredElement.copyComponent(e)):m.info(`not retiring ${e.id} because it's a rendition or dom component`):m.info(`not retiring ${e.id} because retired element does not exist`)}updateComponent(e,t,n){if(!(e instanceof c.a))return m.error("updateComponent: requires a DCXDocumentComponent"),null;const r=this.getComponentWithId(e.componentId);if(!r)return m.error("updateComponent: passed component's ID isn't in the branch; can only update existing components"),null;let i=e;if(t){if(!o.Host.persistUtils||!o.Host.persistUtils.fileExists(t))return m.error("updateComponent: sourceFile can't be used because it's not a faux-temp-file"),null;m.info(`updating component ${e.componentId} with new source file ${t}`),i=new u.DCXDocumentComponentDeferred(this,i.node,{sourceFile:t,copy:n,name:i.name,componentId:i.componentId||"",type:i.type||"",relationship:i.relationship,path:i.path||"",sourceHref:i.sourceHref,node:i.node,content:o.Host.persistUtils.readJsonContentFromFile(t)})}else r!==i?m.info(`updating component ${e.componentId} with new metadata only`):m.warn(`updating component ${e.componentId} but nothing has changed!`);return r!==i&&r.update(i),i}}},vWh2:function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));class o{constructor(){var e,t,n;n=[],(t="queue")in(e=this)?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}add(e){return new Promise((t,n)=>{this.queue.push({f:e,resolve:t,reject:n}),this.processNextOp()})}processNextOp(){const e=this.queue.shift();if(e)try{(t=e.f(),t&&"function"==typeof t.then?t:new Promise(e=>{e(t)})).then(t=>{e.resolve(t),this.processNextOp()}).catch(t=>{e.reject(t),this.processNextOp()})}catch(t){e.reject(t),this.processNextOp()}var t}}},yBTN:function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return c}));var o=n("UzQk"),r=n("MGCh"),i=n.n(r),a=n("a8ov");const s=i.a.channel("WebAssetLoader");class c{constructor(e){var t,n,o;o=void 0,(n="coreWrapper")in(t=this)?Object.defineProperty(t,n,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[n]=o,this.coreWrapper=e}getURLforContentID(e,t,n){const r=e.resources.byContentID(t);let i="";if(r)if(r.storage instanceof o.StorageSpecLocalComposite){const e=this.coreWrapper.documentId(),t=r.storage.componentID,o=r.storage.contentType,s=n&&n.explicitDimension;i=a.default.getImageUrl(e,t,o,s)}else if(r.storage instanceof o.StorageSpecApplicationResource)i=o.Host.resourceUtils.urlForResource(r.storage.categoryID,r.storage.resourceID)||"";else if(r.storage instanceof o.StorageSpecContentLiteral){const e=r.storage.content;e instanceof o.CoreContentBase64?i=e.contentType?`data:${e.contentType};base64,${e.data}`:"data:base64,"+e.data:s.error("unimplemented content literal storage type")}else if(r.storage instanceof o.StorageSpecExternalCC){const e=r.storage,t=e.documentID,o=e.componentID,s=e.contentType||r.contentType,c=n&&n.explicitDimension;i=a.default.getAuthoringContextUrl(t,o,e.etag,s,c)}else if(r.storage instanceof o.StorageSpecCommunityPlatform){const e=r.storage;i=a.default.getCPUrl(e.assetID,e.absPath.forceRelative.asString)}else r.storage instanceof o.StorageSpecHTTP?i=r.storage.url:r.storage instanceof o.StorageSpecLocalFile?s.error("unexpected local file storage spec"):s.error("unimplemented storage type "+r.storage.kind);else s.error(`resource provider for content ID ${t} not found`);return i||a.default.decodeUrl(t)||""}}}}]);
//# sourceMappingURL=post-render-action-view_post-render-doc-view_theo-publish-impl_theo-web-controller_theo-web-headless_bc84d4f2-fdc731cf.js.map